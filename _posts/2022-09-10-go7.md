---
layout: post
title: "[Go lang] ccp & CA - Register & Enroll"
subtitle: register / enroll / ccp / CA / Admin
categories: Go
tags: [ê³ ì–¸ì–´]
---

![](https://velog.velcdn.com/images/-__-/post/beb1cc2e-771d-4b36-b0c6-6a5dd7740082/image.png)

â­ í•˜ì´í¼ë ˆì € íŒ¨ë¸Œë¦­ 2.2 ver ê¸°ì¤€

> **'ë””ì•±'** ì€ ë¸”ë¡ì²´ì¸ ë„¤íŠ¸ì›Œí¬ì— ìˆëŠ” **íŠ¹ì • ì²´ì¸ì½”ë“œì˜ íŠ¹ì • ê¸°ëŠ¥**ì„ ìš”ì²­í•´ì„œ ì‹¤í–‰í•˜ë©´ ê²°ê³¼ë¥¼ ë°›ëŠ”ê²ƒì´ <span style="background-color:#B5E045; color:#000;">ë””ì•±ì˜ ëª©ì ì´ë‹¤</span>

1. ë””ì•±ì€ ìš”ì²­í•˜ê¸° ì „ì— ë””ì•±ì€ **'ì¸ì¦ì„œ'** ë¥¼ ê°€ì§€ê³  ìˆì–´ì•¼í•œë‹¤
   ğŸ‘‰ ê·¸ë˜ì•¼ ë¡œê·¸ì¸ì„ í• ìˆ˜ìˆë‹¤

2. ë””ì•±ì€ **'CA (Certificate Authority)'** ì— ì¸ì¦ì„œë¥¼ ìš”ì²­í•´ì„œ **ì¸ì¦ì„œ**ë¥¼ ë°›ì•„ì™€ì•¼í•œë‹¤

3. **'CA'**ì— ì ‘ì†í•  ìˆ˜ ìˆëŠ” ì£¼ì†Œë¥¼ ê°€ì§€ê³  ìˆì–´ì•¼í•˜ëŠ”ë°

4. ë¸”ë¡ì²´ì¸ ë„¤íŠ¸ì›Œí¬ë¥¼ ì‹¤í–‰ ì‹œí‚¤ë©´ `peer / orderer / CA` ê¹Œì§€ ê°™ì´ ì¼œì§„ë‹¤

5. ë„¤íŠ¸ì›Œí¬ë¥¼ í‚¤ë©´ ì£¼ì†Œê°€ ê²°ì •ë˜ëŠ”ë° ì´ë•Œ ë‹¤ê°™ì´ ìƒì„±ëœ
   `peer / orderer / CA` ì£¼ì†Œë¥¼ ëª¨ì•„ì„œ **'cpp'** json íŒŒì¼ì„ ë§Œë“ ë‹¤
   <span style="background-color:#34CDEF; color:#000;">â­ (ccp = abi ì™€ ë¹„ìŠ·í•¨)</span>

6. ë””ì•±ì€ **'ccp'** ë¥¼ ì½ì–´ì™€ì„œ **'CA'** ì— ì ‘ì†í• ìˆ˜ìˆë‹¤ (ì£¼ì†Œë¥¼ ì•„ë‹ˆê¹Œ)

7. **'CA'** ì— ì ‘ì†ì„ í•´ì„œ ì¸ì¦ì„œë¥¼ ë°›ì•„ì˜¤ê³ 

8. ë°›ì•„ì˜¨ ì¸ì¦ì„œëŠ” <span style="background-color:#BFA8EE; color:#000;">ì§€ê°‘(Wallet) ì— ì €ì¥í•œë‹¤</span>

9. ë””ì•±ì€ ì¸ì¦ì„œë¥¼ êº¼ë‚´ì„œ **'ì¸ì¦'**ì„ í•¨ê³¼ ë™ì‹œì— / ì²´ì¸ì½”ë“œë¥¼ ìš”ì²­í•˜ê³  **ê²°ê³¼**ë¥¼ ë°›ëŠ”ë‹¤

> ì¤€ë¹„ë¬¼ ìƒì„± ğŸ‘‰ ë„¤íŠ¸ì›Œí¬ êµ¬ë™ ğŸ‘‰ ì±„ë„ ì¡°ì¸ ğŸ‘‰ ì•µì»¤í”¼ì–´ ì„¤ì • ğŸ‘‰ ì²´ì¸ì½”ë“œ ì„¤ì¹˜ & ë°°í¬

---

### Register & Enroll

> ê´€ë¦¬ìì˜ ì…ì¥ìœ¼ë¡œì„œ ìœ ì €ë¥¼ ë“±ë¡ ğŸ‘‰ Register<br>
> 'CA' ì— ê´€ë¦¬ì ê³„ì •ì„ ë“±ë¡í•˜ëŠ” í–‰ìœ„ë¥¼ **'Register'** ë¼ê³  í•œë‹¤

> ìœ ì €ì˜ ì…ì¥ìœ¼ë¡œëŠ” ë°œê¸‰ ğŸ‘‰ enroll<br>
> ë“±ë¡ë˜ì–´ìˆëŠ” ì‚¬ìš©ì ì¸ì¦ì„œë¥¼ ë°œê¸‰ ë°›ì•„ì˜¤ëŠ” í–‰ìœ„ë¥¼ **'Enroll'** ì´ë¼ê³  í•œë‹¤

- enrollAdmin ğŸ‘‰ <span style="background-color:#BFA8EE; color:#000;">ê´€ë¦¬ì ì§€ê°‘ ìƒì„±</span> ğŸ‘‰ ì¸ì¦ì„œë°›ê¸°

- registerUser ğŸ‘‰ <span style="background-color:#B5E045; color:#000;">ì‚¬ìš©ì ì§€ê°‘ ìƒì„±</span> ğŸ‘‰ ì¸ì¦ì„œë°›ê¸°

- ê´€ë¦¬ìê°€ ì‚¬ìš©ìë¥¼ ë“±ë¡ì‹œí‚¬ë•Œ <span style="background-color:#BFA8EE; color:#000;">ê´€ë¦¬ì ì¸ì¦ì„œë¥¼ í™•ì¸</span>

- ê´€ë¦¬ìê°€ ë³¸ì¸ì˜ ê¶Œí•œìœ¼ë¡œ **ì‚¬ìš©ìë¥¼ ë“±ë¡**í•´ì¤˜ì•¼ ì‚¬ìš©ìê°€ ì¸ì¦ì„œë¥¼ ë°œê¸‰ë°›ì„ìˆ˜ìˆë‹¤

- ìœ ì € ë“±ë¡ì„ ìœ„í•´ì„œëŠ” **ê´€ë¦¬ì(Admin)** ê¶Œí•œì´ í•„ìš”í•˜ë‹¤

- ê´€ë¦¬ìì˜ ê¶Œí•œìœ¼ë¡œ **'CA'** ì— ë“±ë¡ ğŸ‘‰ ì‚¬ìš©ì ì¸ì¦ì„œ ë°œê¸‰

> ë„¤íŠ¸ì›Œí¬ ë™ì‘ ğŸ‘‰ ë„¤íŠ¸ì›Œí¬ì— ë§ëŠ” CCP ìƒì„± ğŸ‘‰ CCPë¥¼ ì´ìš©í•˜ì—¬ CA ì ‘ì† ğŸ‘‰ í•„ìš”í•œ ì¸ì¦ì„œ ë°œê¸‰ ğŸ‘‰ walletì— ì €ì¥ & êº¼ë‚´ì“°ê¸°

> â­ ì‹¤ì œ ì„œë¹„ìŠ¤ì—ì„œëŠ” `íšŒì›ê°€ì…, í•¸ë“œí° ì¸ì¦` ë“± ê°™ì€ ê³¼ì •ì„ ê±°ì³ì„œ ì¸ì¦ì„œë¥¼ ë°œê¸‰ **(Enroll)**

> ### ì˜ˆë¥¼ë“¤ì–´
>
> íšŒì‚¬(CA)ì— **ì²˜ìŒ ì…ì‚¬í–ˆì„ë•Œ** íšŒì‚¬ DBì— ë„£ì„ <br>
> ë‚˜ì˜ ê°œì¸ì •ë³´ë¥¼ <span style="background-color:#B5E045; color:#000;">ìµœì´ˆë¡œ ë“±ë¡í•˜ëŠ” ê³¼ì •</span>
> ğŸ‘‰ **Register** <br>
>
> íšŒì‚¬(CA)ì— ë‚´ê°€ ì¶œì…ì¹´ë“œë¥¼ ë°œê¸‰ìš”ì²­í•˜ë©´ ì¶œì…ì¹´ë“œë¥¼ ì¤€ë‹¤<br>
> íšŒì‚¬ DBì—ëŠ” ë‚˜ì˜ ì •ë³´ê°€ ë“±ë¡ë˜ì–´ìˆì„ ê²ƒì´ë‹¤<br>
> ğŸ‘‰ ë“±ë¡ë˜ì–´ìˆëŠ” DBë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì¶œì…ì¹´ë“œë¥¼ <span style="background-color:#BFA8EE; color:#000;">ë°œê¸‰í•´ì¤€ë‹¤</span> **(Enroll)**<br>
> ì¶œì…ì¹´ë“œë¥¼ ë¶„ì‹¤í–ˆì–´ë„ DBë¥¼ ê¸°ì¤€ìœ¼ë¡œ <span style="background-color:#BFA8EE; color:#000;">ì¬ë°œê¸‰ì´ ê°€ëŠ¥í•˜ë‹¤</span>

---

### enrollAdmin ì½”ë“œ

> 1. **'ccp'** ì— ì ‘ê·¼í•´ì„œ CA ì£¼ì†Œë¥¼ ì°¾ëŠ” ì‘ì—…
> 2. ì§€ê°‘ ìœ ë¬´ í™•ì¸ ì²´í¬ (**ê´€ë¦¬ì ê¶Œí•œ** ì²´í¬)
> 3. ê´€ë¦¬ì ê¶Œí•œìœ¼ë¡œ **ì¸ì¦ì„œ ë°œê¸‰** í›„ ì§€ê°‘ì— ì €ì¥

```js
"use strict";

const FabricCAServices = require("fabric-ca-client");
const { Wallets } = require("fabric-network");
const fs = require("fs");
const path = require("path");

async function main() {
  try {
    const ccpPath = path.resolve(__dirname, "ccp", "connection-org1.json");
    // ccp íŒŒì¼ json ì— ì ‘ê·¼ ğŸ‘‰ ì ‘ì†í•  ì£¼ì†Œë¥¼ ì°¾ì•„ì•¼í•¨
    const ccp = JSON.parse(fs.readFileSync(ccpPath, "utf8"));
    // jsonì„ parse ì‹œí‚¨ë‹¤

    const caInfo = ccp.certificateAuthorities["ca.org1.example.com"];
    // json íŒŒì¼ì—ì„œ ì ‘ì†í•  url ì£¼ì†Œë¥¼ ì°¾ìŒ
    const caTLSCACerts = caInfo.tlsCACerts.pem;
    // ì°¾ì€ url CA ì£¼ì†Œ
    const ca = new FabricCAServices(
      caInfo.url,
      { trustedRoots: caTLSCACerts, verify: false },
      caInfo.caName
    );

    const walletPath = path.join(process.cwd(), "wallet");
    // wallet ì—´ê¸° / ì—†ìœ¼ë©´ ìƒì„± / í˜„ì¬ê²½ë¡œì—
    const wallet = await Wallets.newFileSystemWallet(walletPath);
    console.log(`Wallet path: ${walletPath}`);

    const identity = await wallet.get("admin");
    // admin ì´ë¼ëŠ” ì¸ì¦ì„œê°€ ìˆëŠ”ì§€ í™•ì¸
    if (identity) {
      console.log(
        'An identity for the admin user "admin" already exists in the wallet'
      );
      return;
    }

    // â­ CAê°€ ì¼œì§ˆë•Œ admin í•˜ë‚˜ëŠ” register ëœ ìƒíƒœë¡œ ì¼œì§„ë‹¤
    // ìµœì´ˆì˜ ê´€ë¦¬ì
    const enrollment = await ca.enroll({
      enrollmentID: "admin", // ìµœì´ˆ ì´ë¯¸ ë“±ë¡ë˜ì–´ìˆëŠ” ê´€ë¦¬ì ì•„ì´ë””
      enrollmentSecret: "adminpw", // ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸
    });
    const x509Identity = {
      credentials: {
        certificate: enrollment.certificate, // ê´€ë¦¬ìê¶Œí•œìœ¼ë¡œ ë°œê¸‰
        privateKey: enrollment.key.toBytes(), // ê´€ë¦¬ìê¶Œí•œìœ¼ë¡œ ë°œê¸‰
      },
      mspId: "Org1MSP",
      type: "X.509",
    };
    await wallet.put("admin", x509Identity);
    // ì§€ê°‘ì— ê´€ë¦¬ì ì¸ì¦ì„œê°€ í•œê°œ ë°œê¸‰ë˜ì–´ ì €ì¥(put)
    console.log(
      'Successfully enrolled admin user "admin" and imported it into the wallet'
    );
  } catch (error) {
    console.error(`Failed to enroll admin user "admin": ${error}`);
    process.exit(1);
  }
}

main();
```

---

### registerUser ì½”ë“œ

> 1. **'ccp'** ì— ì ‘ê·¼í•´ì„œ CA ì£¼ì†Œë¥¼ ì°¾ëŠ” ì‘ì—…
> 2. ì§€ê°‘ ìœ ë¬´ í™•ì¸ ì²´í¬ (**ê´€ë¦¬ì ê¶Œí•œ** ì²´í¬)
> 3. ê´€ë¦¬ìì˜ ê¶Œí•œìœ¼ë¡œ ìœ ì €ë¥¼ ë“±ë¡

```js
"use strict";

const { Wallets } = require("fabric-network");
const FabricCAServices = require("fabric-ca-client");
const fs = require("fs");
const path = require("path");

async function main() {
  try {
    const ccpPath = path.resolve(__dirname, "ccp", "connection-org1.json"); // ccp íŒŒì¼ json ì— ì ‘ê·¼ ğŸ‘‰ ì ‘ì†í•  ì£¼ì†Œë¥¼ ì°¾ì•„ì•¼í•¨
    const ccp = JSON.parse(fs.readFileSync(ccpPath, "utf8"));
    // jsonì„ parse ì‹œí‚¨ë‹¤

    const caURL = ccp.certificateAuthorities["ca.org1.example.com"].url;
    // json íŒŒì¼ì—ì„œ ì ‘ì†í•  url ì£¼ì†Œë¥¼ ì°¾ìŒ
    const ca = new FabricCAServices(caURL); // ì°¾ì€ url CA ì£¼ì†Œ

    const walletPath = path.join(process.cwd(), "wallet");
    const wallet = await Wallets.newFileSystemWallet(walletPath);
    console.log(`Wallet path: ${walletPath}`);

    const userIdentity = await wallet.get("appUser");
    if (userIdentity) {
      console.log(
        'An identity for the user "appUser" already exists in the wallet'
      );
      return;
    }

    const adminIdentity = await wallet.get("admin");
    // admin(ê´€ë¦¬ì) ê¶Œí•œ ë¶ˆëŸ¬ì˜¤ê¸°
    if (!adminIdentity) {
      console.log(
        'An identity for the admin user "admin" does not exist in the wallet'
      );
      console.log("Run the enrollAdmin.js application before retrying");
      return;
    }

    const provider = wallet
      .getProviderRegistry()
      .getProvider(adminIdentity.type);
    const adminUser = await provider.getUserContext(adminIdentity, "admin"); // ê´€ë¦¬ìê¶Œí•œ ìƒì„±

    const secret = await ca.register(
      {
        affiliation: "org1.department1", // ì†Œì†
        enrollmentID: "appUser", // ì•„ì´ë””
        role: "client", // ì—­í• (ê¶Œí•œ)
      }, // admin / peer / client 3ê°œì¤‘ í•˜ë‚˜
      adminUser // ê´€ë¦¬ì ê¶Œí•œìœ¼ë¡œ User ë“±ë¡
    );
    //------------ admin (ê´€ë¦¬ì)ì˜ ì—­í•  ë
    //------------ dapp ì—ì„œ ì¡°ì‘í•´ì•¼í•  ì˜ì—­ ğŸ‘‡ğŸ‘‡
    const enrollment = await ca.enroll({
      enrollmentID: "appUser",
      enrollmentSecret: secret,
    });
    const x509Identity = {
      credentials: {
        certificate: enrollment.certificate,
        privateKey: enrollment.key.toBytes(),
      },
      mspId: "Org1MSP",
      type: "X.509",
    };
    await wallet.put("appUser", x509Identity);
    console.log(
      'Successfully registered and enrolled admin user "appUser" and imported it into the wallet'
    );
  } catch (error) {
    console.error(`Failed to register user "appUser": ${error}`);
    process.exit(1);
  }
}

main();
```

---
